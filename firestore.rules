rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdminEmail() {
      return request.auth.token.email in [
        'jdioses@outlook.be',
        'antoleod@gmail.com'
      ];
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && (
        isSuperAdminEmail() ||
        getUserRole(request.auth.uid) == 'admin'
      );
    }

    function isCustomer() {
      return isAuthenticated() && getUserRole(request.auth.uid) == 'customer';
    }

    // Denegar todo por defecto para mayor seguridad.
    match /{document=**} {
      allow read, write: if false;
    }

    // =================================
    // Collections Rules
    // =================================

    // --- Usuarios ---
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && !('role' in request.resource.data);
    }

    // --- KYC (Know Your Customer) ---
    match /kyc/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create, update: if isOwner(userId);
    }

    // --- Solicitudes de Préstamo ---
    match /loan_requests/{requestId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerUid == request.auth.uid);
      allow create: if isCustomer() && request.resource.data.customerUid == request.auth.uid;
      allow update: if isAdmin() || (resource.data.customerUid == request.auth.uid && !('status' in request.resource.data));
    }

    // --- Préstamos ---
    match /loans/{loanId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerUid == request.auth.uid);
      allow create, update: if isAdmin();
    }

    // --- Garantías (Collateral) ---
    match /collaterals/{collateralId} {
      // Permitir leer si es admin, dueño, o si el artículo está a la venta (Marketplace)
      allow read: if isAdmin() || 
                    (isAuthenticated() && resource.data.ownerUid == request.auth.uid) ||
                    (resource.data.isForSale == true);
      
      allow create: if isCustomer() && request.resource.data.ownerUid == request.auth.uid;
      allow update: if isAdmin();
    }

    // --- Pagos ---
    match /payments/{paymentId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerUid == request.auth.uid);
      allow create: if isCustomer() && request.resource.data.customerUid == request.auth.uid;
      allow update: if isAdmin();
    }

    // --- Lealtad (Loyalty) ---
    match /users/{userId}/loyalty/{doc} {
       allow read: if isOwner(userId) || isAdmin();
       allow write: if isAdmin();
    }

    // --- Configuración Global ---
    match /settings/global {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Soporte (Support Tickets) ---
    match /support_tickets/{ticketId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.customerUid == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.customerUid == request.auth.uid;
      allow update: if isAdmin();
    }

    // --- Bitácora de Auditoría ---
    match /audit_logs/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
